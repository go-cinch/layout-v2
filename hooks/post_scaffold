#!/bin/bash
# Post-scaffold hook to rename files and initialize project

set -e

PROJECT_NAME="{{ .Computed.service_name_final }}"
PROTO_TEMPLATE="{{ .Scaffold.proto_template }}"
PROJECT_DIR="{{ .Project }}"
ENABLE_DB="{{ .Computed.enable_db_final }}"
ORM_TYPE="{{ .Computed.orm_type_final }}"
ENABLE_GEN_MODEL="{{ .Computed.enable_gen_model_final }}"

# Track failed steps
FAILED_STEPS=()

# Change to project directory
cd "$PROJECT_DIR"

echo ""
echo "=========================================="
echo "Post-scaffold: Initializing $PROJECT_NAME"
echo "=========================================="
echo "Working in: $(pwd)"
echo ""

# ===========================================
# Phase 1: File cleanup and renaming
# ===========================================
echo "Phase 1: Cleaning up template files..."
echo "-------------------------------------------"

# Rename migration files with timestamp
if [ "$ENABLE_DB" = "true" ] && [ -d "./internal/db/migrations" ]; then
    TIMESTAMP=$(date +"%Y%m%d%H")
    find ./internal/db/migrations -type f -name "YYYYMMDDHH-*.sql" 2>/dev/null | while read -r file; do
        newfile="${file/YYYYMMDDHH/$TIMESTAMP}"
        if [ -f "$file" ] && [ ! -f "$newfile" ]; then
            mv "$file" "$newfile"
            echo "Renamed migration: $(basename $file) -> $(basename $newfile)"
        fi
    done
fi

# Remove the unselected proto and service files
if [ "$PROTO_TEMPLATE" = "simple" ]; then
    # Remove .full files
    find ./api -type f -name "*.full.proto" -delete 2>/dev/null || true
    find ./internal/service -type f -name "service.full.go" -delete 2>/dev/null || true
    find ./internal/data -type f -name "game.full.go" -delete 2>/dev/null || true
    find ./internal/biz -type f -name "game.full.go" -delete 2>/dev/null || true
    echo "Removed .full template files"

    # Rename .simple.proto to .proto (if any exist)
    find ./api -type f -name "*.simple.proto" 2>/dev/null | while read -r file; do
        newfile="${file/.simple.proto/.proto}"
        if [ -f "$file" ] && [ ! -f "$newfile" ]; then
            mv "$file" "$newfile"
            echo "Renamed: $file -> $newfile"
        fi
    done

    # Rename service.simple.go to service.go (if exists)
    if [ -f "./internal/service/service.simple.go" ] && [ ! -f "./internal/service/service.go" ]; then
        mv "./internal/service/service.simple.go" "./internal/service/service.go"
        echo "Renamed: service.simple.go -> service.go"
    fi

    # Rename game.simple.go directly to ${PROJECT_NAME}.go
    if [ -f "./internal/data/game.simple.go" ]; then
        mv "./internal/data/game.simple.go" "./internal/data/${PROJECT_NAME}.go"
        echo "Renamed: data/game.simple.go -> data/${PROJECT_NAME}.go"
    fi

    if [ -f "./internal/biz/game.simple.go" ]; then
        mv "./internal/biz/game.simple.go" "./internal/biz/${PROJECT_NAME}.go"
        echo "Renamed: biz/game.simple.go -> biz/${PROJECT_NAME}.go"
    fi

elif [ "$PROTO_TEMPLATE" = "full" ]; then
    # Remove .simple files
    find ./api -type f -name "*.simple.proto" -delete 2>/dev/null || true
    find ./internal/service -type f -name "service.simple.go" -delete 2>/dev/null || true
    find ./internal/data -type f -name "game.simple.go" -delete 2>/dev/null || true
    find ./internal/biz -type f -name "game.simple.go" -delete 2>/dev/null || true
    echo "Removed .simple template files"

    # Rename .full.proto to .proto (if any exist)
    find ./api -type f -name "*.full.proto" 2>/dev/null | while read -r file; do
        newfile="${file/.full.proto/.proto}"
        if [ -f "$file" ] && [ ! -f "$newfile" ]; then
            mv "$file" "$newfile"
            echo "Renamed: $file -> $newfile"
        fi
    done

    # Rename service.full.go to service.go (if exists)
    if [ -f "./internal/service/service.full.go" ] && [ ! -f "./internal/service/service.go" ]; then
        mv "./internal/service/service.full.go" "./internal/service/service.go"
        echo "Renamed: service.full.go -> service.go"
    fi

    # Rename game.full.go directly to ${PROJECT_NAME}.go
    if [ -f "./internal/data/game.full.go" ]; then
        mv "./internal/data/game.full.go" "./internal/data/${PROJECT_NAME}.go"
        echo "Renamed: data/game.full.go -> data/${PROJECT_NAME}.go"
    fi

    if [ -f "./internal/biz/game.full.go" ]; then
        mv "./internal/biz/game.full.go" "./internal/biz/${PROJECT_NAME}.go"
        echo "Renamed: biz/game.full.go -> biz/${PROJECT_NAME}.go"
    fi

    if [ -f "./internal/tests/service/game_test.go" ]; then
        mv "./internal/tests/service/game_test.go" "./internal/tests/service/${PROJECT_NAME}_test.go"
        echo "Renamed: tests/game_test.go -> tests/${PROJECT_NAME}_test.go"
    fi
fi

echo "✓ File cleanup completed"

# ===========================================
# Phase 2: Project initialization
# ===========================================
echo ""
echo "Phase 2: Project initialization..."
echo "-------------------------------------------"

# Determine total steps based on configuration
if [ "$ENABLE_DB" = "true" ]; then
    if [ "$ENABLE_GEN_MODEL" = "true" ] && [ "$ORM_TYPE" = "gorm" ]; then
        TOTAL_STEPS=5
    else
        TOTAL_STEPS=4
    fi
else
    TOTAL_STEPS=2
fi

CURRENT_STEP=1

echo ""
echo "Step $CURRENT_STEP/$TOTAL_STEPS: Installing tools..."
echo "-------------------------------------------"
if make init; then
    echo "✓ Tools installed"
else
    echo "✗ Tool installation failed"
    FAILED_STEPS+=("make init")
fi
CURRENT_STEP=$((CURRENT_STEP + 1))

# Database-related steps only if database is enabled
if [ "$ENABLE_DB" = "true" ]; then
    echo ""
    echo "Step $CURRENT_STEP/$TOTAL_STEPS: Creating database..."
    echo "-------------------------------------------"
    if make gen-createdb; then
        echo "✓ Database ready"
    else
        echo "⚠️  Database creation failed (may already exist or container not running)"
        FAILED_STEPS+=("make gen-createdb")
    fi
    CURRENT_STEP=$((CURRENT_STEP + 1))

    echo ""
    echo "Step $CURRENT_STEP/$TOTAL_STEPS: Running migrations..."
    echo "-------------------------------------------"
    if make gen-up; then
        echo "✓ Migrations applied"
    else
        echo "⚠️  Migration failed"
        FAILED_STEPS+=("make gen-up")
    fi
    CURRENT_STEP=$((CURRENT_STEP + 1))

    # Generate models only if enabled and using gorm
    if [ "$ENABLE_GEN_MODEL" = "true" ] && [ "$ORM_TYPE" = "gorm" ]; then
        echo ""
        echo "Step $CURRENT_STEP/$TOTAL_STEPS: Generating GORM models..."
        echo "-------------------------------------------"
        if make gen-model; then
            echo "✓ Models generated"
            echo "Generated models:"
            ls -1 internal/data/model/*.gen.go 2>/dev/null | sed 's/^/  /' || echo "  (no .gen.go files found)"
        else
            echo "⚠️  Model generation failed"
            FAILED_STEPS+=("make gen-model")
        fi
        CURRENT_STEP=$((CURRENT_STEP + 1))
    fi
fi

echo ""
echo "Step $CURRENT_STEP/$TOTAL_STEPS: Generating proto and building..."
echo "-------------------------------------------"
if make all; then
    echo "✓ Build completed"
else
    echo "✗ Build failed"
    FAILED_STEPS+=("make all")
fi

echo ""
echo "=========================================="

# Check if any steps failed
if [ ${#FAILED_STEPS[@]} -gt 0 ]; then
    echo "⚠️  Project $PROJECT_NAME created with warnings"
    echo "=========================================="
    echo ""
    echo "Some steps had issues. You may need to run manually:"
    echo ""
    echo "  cd $PROJECT_DIR"
    for step in "${FAILED_STEPS[@]}"; do
        echo "  $step"
    done
    echo ""
else
    echo "✓ Project $PROJECT_NAME initialized successfully!"
    echo "=========================================="
    echo ""
    echo "Next steps:"
    echo "  cd $PROJECT_DIR"
    echo "  make run     # Start the service"
    echo ""
fi
